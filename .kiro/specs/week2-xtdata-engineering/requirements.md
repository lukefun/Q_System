# 需求文档：第二周 - XtData金融数据工程

## 简介

本规范定义了120天量化交易培训计划第二周的需求。第二周专注于使用XtData API进行金融数据工程，涵盖市场数据获取、价格复权机制、基本面数据处理、行业分类、数据持久化和可视化。系统将使学习者能够构建本地全市场日线数据库，正确处理未来函数问题并实现高效的增量更新。

## 术语表

- **XtData接口**: 用于获取中国市场金融数据的外部API服务
- **数据获取模块**: 负责从XtData API获取市场数据的组件
- **复权处理器**: 对历史价格应用前复权或后复权的组件
- **基本面数据处理器**: 管理财务指标(PE、PB、ROE)并具有时间点意识的组件
- **行业映射器**: 管理申万行业分类和股票-行业关系的组件
- **数据管理器**: 负责数据持久化和增量更新的组件
- **可视化器**: 生成金融图表和可视化的组件
- **未来函数/前瞻偏差**: 在历史分析中使用未来信息的错误
- **前复权**: 从分红送股事件向前调整历史价格的方法，保持当前价格不变
- **后复权**: 从当前价格向后调整历史价格的方法，保持历史价格连续性
- **申万分类**: 中国市场使用的标准行业分类体系
- **HDF5**: 分层数据格式第5版，高效的二进制存储格式
- **增量更新**: 仅添加新数据而不重新处理现有数据的过程
- **K线图**: 展示股票开盘价、最高价、最低价、收盘价及成交量的蜡烛图
- **Tick数据**: 具备精准时间戳的逐笔交易级市场数据
- **日线数据**: 按日频聚合的市场数据（周期为1天）
- **OHLCV**: 开盘价(Open)、最高价(High)、最低价(Low)、收盘价(Close)、成交量(Volume)的缩写

## 需求

### 需求1：XtData API集成

**用户故事：** 作为量化交易员，我想从XtData API获取市场数据，以便访问历史和实时的中国市场数据进行分析。

#### 验收标准

1. WHEN 使用有效参数调用download_history_data时，THE 数据获取模块 SHALL 返回指定证券和时间范围的历史市场数据
2. WHEN 使用有效参数调用get_market_data时，THE 数据获取模块 SHALL 返回当前市场快照数据
3. WHEN 请求tick级别数据时，THE 数据获取模块 SHALL 返回至少精确到秒的时间戳数据
4. WHEN 请求日线(1d)数据时，THE 数据获取模块 SHALL 返回每个交易日一条记录的数据
5. IF API连接失败，THEN THE 数据获取模块 SHALL 返回描述性错误消息并保持系统稳定
6. WHEN 同时请求多个证券时，THE 数据获取模块 SHALL 高效处理批量请求

### 需求2：价格复权实现

**用户故事：** 作为量化交易员，我想对历史数据应用价格复权，以便在回测中准确处理公司行为事件而不产生扭曲。

#### 验收标准

1. WHEN 请求前复权时，THE 复权处理器 SHALL 从分红送股事件向前调整所有历史价格
2. WHEN 请求后复权时，THE 复权处理器 SHALL 从当前价格向后调整所有历史价格
3. WHEN 处理回测数据时，THE 复权处理器 SHALL 默认使用前复权以避免未来函数
4. WHEN 股票有分红或拆股事件时，THE 复权处理器 SHALL 对OHLCV数据一致地应用复权因子
5. THE 复权处理器 SHALL 保持每个交易日内的相对价格关系
6. WHEN 复权因子不可用时，THE 复权处理器 SHALL 返回未复权数据并发出警告

### 需求3：基本面数据ETL

**用户故事：** 作为量化交易员，我想提取和转换基本面财务数据，以便在交易策略中纳入估值指标而不产生未来函数。

#### 验收标准

1. WHEN 请求特定日期的基本面数据时，THE 基本面数据处理器 SHALL 仅返回在该日期或之前公开可用的数据
2. WHEN 计算PE比率时，THE 基本面数据处理器 SHALL 使用正确的价格和盈利数据并进行适当的时间对齐
3. WHEN 计算PB比率时，THE 基本面数据处理器 SHALL 使用正确的价格和账面价值数据并进行适当的时间对齐
4. WHEN 获取ROE时，THE 基本面数据处理器 SHALL 将其与正确的报告期关联
5. THE 基本面数据处理器 SHALL 优雅地处理缺失或空的基本面数据而不导致系统故障
6. WHEN 季度财务报告发布时，THE 基本面数据处理器 SHALL 将其与正确的公告日期关联，而非报告期结束日期

### 需求4：行业分类管理

**用户故事：** 作为量化交易员，我想访问行业分类数据，以便进行板块分析和构建行业中性组合。

#### 验收标准

1. WHEN 请求申万行业分类时，THE 行业映射器 SHALL 返回完整的行业层级结构
2. WHEN 查询股票代码时，THE 行业映射器 SHALL 返回其在所有层级的当前行业分类
3. WHEN 请求行业成分股时，THE 行业映射器 SHALL 返回属于指定行业的所有股票
4. THE 行业映射器 SHALL 处理具有适当生效日期的行业重新分类事件
5. WHEN 股票的行业随时间变化时，THE 行业映射器 SHALL 返回任何历史日期的正确行业
6. THE 行业映射器 SHALL 支持按行业代码或行业名称查询

### 需求5：数据持久化和管理

**用户故事：** 作为量化交易员，我想在本地存储市场数据并具有增量更新能力，以便最小化API调用并高效维护最新的本地数据库。

#### 验收标准

1. WHEN 保存数据时，THE 数据管理器 SHALL 以HDF5格式存储以实现高效访问
2. WHERE 需要CSV导出时，THE 数据管理器 SHALL 提供转换功能
3. WHEN 触发增量更新时，THE 数据管理器 SHALL 识别最后可用日期并仅获取新数据
4. WHEN 更新期间检测到重复数据时，THE 数据管理器 SHALL 跳过冗余记录
5. THE 数据管理器 SHALL 在并发读取操作期间保持数据完整性
6. WHEN 存储空间有限时，THE 数据管理器 SHALL 提供数据压缩选项
7. THE 数据管理器 SHALL 支持按股票代码、日期范围和数据类型查询数据

### 需求6：金融数据可视化

**用户故事：** 作为量化交易员，我想用技术指标可视化市场数据，以便直观检查数据质量并理解价格模式。

#### 验收标准

1. WHEN 请求K线图时，THE 可视化器 SHALL 显示带有OHLC数据的蜡烛图
2. WHEN 指定移动平均线时，THE 可视化器 SHALL 将其叠加在价格图表上
3. WHEN 成交量数据可用时，THE 可视化器 SHALL 在价格图表下方显示成交量柱状图
4. THE 可视化器 SHALL 根据市场惯例为上涨日使用适当的颜色(红色/绿色)
5. THE 可视化器 SHALL 清晰地标注日期和价格轴
6. WHEN 可视化多个证券时，THE 可视化器 SHALL 支持子图布局
7. THE 可视化器 SHALL 支持将图表保存为常见格式的图像文件(PNG、JPG)

### 需求7：未来函数防范

**用户故事：** 作为量化交易员，我想让系统防止未来函数，以便回测结果反映真实的交易条件。

#### 验收标准

1. WHEN 执行历史分析时，THE 系统 SHALL 确保计算中不使用未来数据
2. WHEN 访问基本面数据时，THE 系统 SHALL 基于公告日期强制执行时间点正确性
3. WHEN 为回测应用价格复权时，THE 系统 SHALL 专门使用前复权
4. THE 系统 SHALL 在数据处理中记录所有时间点假设
5. WHEN 跨不同数据源执行数据对齐时，THE 系统 SHALL 使用保守的日期匹配以避免信息泄露

### 需求8：全市场数据库构建

**用户故事：** 作为量化交易员，我想构建完整的本地日线市场数据库，以便在不重复API调用的情况下进行全面的市场分析。

#### 验收标准

1. WHEN 启动全市场下载时，THE 系统 SHALL 获取所有可用证券的日线数据
2. THE 系统 SHALL 通过适当的延迟优雅地处理API速率限制
3. WHEN 下载中断时，THE 系统 SHALL 支持从最后成功点恢复
4. THE 系统 SHALL 在下载后验证数据完整性
5. THE 系统 SHALL 在大规模数据下载期间提供进度报告
6. WHEN 数据库完成时，THE 系统 SHALL 提供汇总统计信息(证券数量、日期范围、数据量)

### 需求9：错误处理和数据质量

**用户故事：** 作为量化交易员，我想要健壮的错误处理和数据质量检查，以便信任分析和交易系统中的数据。

#### 验收标准

1. WHEN 提供无效股票代码时，THE 系统 SHALL 返回清晰的错误消息
2. WHEN 数据包含异常(例如负价格、极端值)时，THE 系统 SHALL 标记它们以供审查
3. WHEN API返回不完整数据时，THE 系统 SHALL 记录问题并继续处理有效数据
4. THE 系统 SHALL 在存储前验证数据类型和范围
5. WHEN 检测到数据缺口时，THE 系统 SHALL 报告缺失的日期范围
6. THE 系统 SHALL 维护错误日志以供故障排除和审计

### 需求10：教学文档

**用户故事：** 作为量化交易培训计划的学习者，我想要清晰的文档和示例，以便理解金融数据工程概念和最佳实践。

#### 验收标准

1. THE 系统 SHALL 为所有公共函数和类包含文档字符串
2. THE 系统 SHALL 提供演示每个主要功能的示例脚本
3. THE 系统 SHALL 记录前复权与后复权的理由
4. THE 系统 SHALL 用具体示例解释未来函数
5. THE 系统 SHALL 包含解释复杂数据转换的注释
6. THE 系统 SHALL 提供包含设置说明和使用示例的README

### 需求11：练习结构与文档规范

**用户故事：** 作为量化交易培训计划的学习者，我想要结构清晰的练习内容和规范的文档，以便循序渐进地学习并方便随时查阅资料。

#### 验收标准

1. THE 系统 SHALL 将第二周的所有练习内容组织在`exercises/week2/`目录下
2. THE 系统 SHALL 遵循`dayN_topic.py`的文件命名规范（其中N为天数）
3. THE 系统 SHALL 为每个练习配置文档字符串，说明涉及的金融概念
4. THE 系统 SHALL 为每个核心函数提供使用示例及预期输出结果
5. THE 系统 SHALL 在`exercises/week2/`目录下包含README文件，概述本周学习目标与练习进阶路径
6. WHEN 后续练习需基于前序内容时，THE 系统 SHALL 在文档中明确标注所需的前置知识或关联文件
